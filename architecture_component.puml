@startuml
title BJJ Vienna - Component Diagram

skinparam componentStyle rectangle
skinparam packageStyle rectangle
skinparam shadowing false

actor "User" as user

package "Desktop App (Tkinter)" {
  [gui.py\n(main window + tabs)] as gui
  [ui.students] as ui_students
  [ui.teachers] as ui_teachers
  [ui.locations] as ui_locations
  [ui.sessions] as ui_sessions
  [ui.attendance] as ui_attendance
  [ui.news_notifications] as ui_news
  [ui.reports] as ui_reports
  [ui.settings] as ui_settings
  [ui.about] as ui_about

  [api_client.py\nJWT login + Bearer calls] as api_client
  [db.py\nlegacy direct DB path] as db
  [i18n.py\ntranslations + language persistence] as i18n
  [validation_middleware.py] as validation
  [error_middleware.py] as errors
  [version.py] as version
}

package "API Backend (Canonical)" {
  [backend/main.py\nFastAPI app + auth/roles] as api
  [backend/run.py\nuvicorn launcher] as api_run
  [backend/config.py\nenv loading + security validation] as api_cfg
  [backend/security.py\nJWT + password hashing] as api_sec
  [backend/db.py\nDB pool + queries] as api_db
}

package "Compatibility Entry Point" {
  [main.py\nwrapper -> backend.run] as main_wrapper
}

package "Ops / Tooling" {
  [scripts/bootstrap_instance.py\nbootstrap env + app_settings] as bootstrap
  [scripts/check_instance_config.py\nstrict env/settings validation] as check_cfg
  [run_api.bat\nstartup banner + validation] as run_api_bat
  [installer/bjjvienna.iss\ninstaller + first-run settings page] as installer
  [.github/workflows/ci.yml\n3.11 stable + 3.14 experimental] as ci
  [.github/workflows/release.yml\nquality gate + release] as release
}

database "PostgreSQL" as pg
collections "i18n/*.json" as i18n_files
collections "app_settings.json" as settings
collections "backend/.env*" as env_cfg
collections "app.log" as logs
collections "CSV/PDF/XLSX exports" as exports
collections "docs/PROD_SECURITY_CHECKLIST.md" as prod_docs

user --> gui

gui --> ui_students
gui --> ui_teachers
gui --> ui_locations
gui --> ui_sessions
gui --> ui_attendance
gui --> ui_news
gui --> ui_reports
gui --> ui_settings
gui --> ui_about
gui --> version

ui_students --> api_client
ui_teachers --> api_client
ui_locations --> api_client
ui_sessions --> api_client
ui_attendance --> api_client
ui_news --> api_client
ui_reports --> api_client

ui_students ..> db : fallback/legacy
ui_teachers ..> db : fallback/legacy
ui_locations ..> db : fallback/legacy
ui_sessions ..> db : fallback/legacy
ui_attendance ..> db : fallback/legacy
ui_news ..> db : fallback/legacy
ui_reports ..> db : fallback/legacy

ui_students --> validation
ui_teachers --> validation
ui_locations --> validation
ui_sessions --> validation

ui_students --> errors
ui_teachers --> errors
ui_locations --> errors
ui_sessions --> errors

gui --> i18n
ui_students --> i18n
ui_teachers --> i18n
ui_locations --> i18n
ui_sessions --> i18n
ui_attendance --> i18n
ui_news --> i18n
ui_reports --> i18n
ui_settings --> i18n
ui_about --> i18n

db --> pg
db --> env_cfg
api_client --> settings
api_client --> api

api_run --> api
main_wrapper --> api_run
api --> api_sec
api --> api_db
api --> api_cfg
api_db --> pg
api_cfg --> env_cfg

i18n --> i18n_files
i18n --> settings
ui_about --> settings
gui --> logs
errors --> logs
ui_about --> logs
ui_reports --> exports

bootstrap --> env_cfg
bootstrap --> settings
check_cfg --> env_cfg
check_cfg --> settings
run_api_bat --> check_cfg
run_api_bat --> bootstrap
installer --> settings
release --> ci
release --> prod_docs

note right of api
  Canonical backend implementation.
  Includes JWT auth, roles and
  login rate-limiting.
end note

note right of env_cfg
  Backend source of truth:
  backend/.env*
end note

@enduml
